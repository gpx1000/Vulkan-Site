<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Compressed triangle data :: Vulkan Documentation Project</title>
    <meta name="generator" content="Antora 3.1.10">
    <script>
      !function (theme) {
        if (theme === 'dark') document.documentElement.classList.add('dark')
        else document.documentElement.classList.add('light')
      }(localStorage && localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)')?.matches && 'dark'))
    </script>
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="stylesheet" href="../../../../_/css/vendor/tabs.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../../../../_/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../../_/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../../_/img/favicon-16x16.png">
    <link rel="manifest" href="../../../../_/site.webmanifest">
    <link rel="mask-icon" href="../../../../_/img/safari-pinned-tab.svg" color="#a41e22">
    <meta name="msapplication-TileColor" content="#ffc40d">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../.."><img class="navbar-item" alt="Vulkan White Label" src="../../../../_/Vulkan_Docs.svg" /></a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field has-filter">
          <label for="search-input"></label>
          <input id="search-input" type="text" placeholder="Search the docs">
          <label class="filter checkbox">
            <input type="checkbox" data-facet-filter="component:spec" checked> In this component
          </label>
        </div>
      </div>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <!-- <a class="navbar-item" href="#">Home</a> -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Specs</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../spec/latest/chapters/introduction.html">Vulkan API</a>
            <a class="navbar-item" href="../../../../glsl/latest/index.html">GLSL</a>
            <a class="navbar-item" href="../../../../guide/latest/hlsl.html">HLSL</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Education</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../refpages/latest/refpages/index.html">Vulkan Reference Pages</a>
            <a class="navbar-item" href="../../../../features/latest/features/index.html">Vulkan Feature Descriptions</a>
            <a class="navbar-item" href="../../../../guide/latest/index.html">Vulkan Guide</a>
            <a class="navbar-item" href="../../../../samples/latest/README.html">Vulkan Samples</a>
            <a class="navbar-item" href="../../../../tutorial/latest/index.html">Vulkan Tutorial</a>
            <a class="navbar-item" href="https://www.youtube.com/c/vulkan">YouTube</a>
            <a class="navbar-item" href="https://vulkan.org">More Info at Vulkan.org</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Feedback</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://github.com/KhronosGroup/Vulkan-Site/issues/new/choose" target="_blank">Report a Problem</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://discord.gg/vulkan">Vulkan Discord</a>
            <a class="navbar-item" href="https://reddit.com/r/vulkan">Reddit</a>
            <a class="navbar-item" href="https://stackoverflow.com/questions/tagged/vulkan">Stack Overflow</a>
            <a class="navbar-item" href="https://fosstodon.org/@vulkan">Mastodon</a>
          </div>
        </div>
      </div>
    </div>
    <label class="theme-toggler">
      <input type="checkbox" id="switch-theme-checkbox" name="switch-theme-checkbox"/>
      <span class="icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="moon" class="svg-inline--fa fa-moon moon" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M223.5 32C100 32 0 132.3 0 256S100 480 223.5 480c60.6 0 115.5-24.2 155.8-63.4c5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6c-96.9 0-175.5-78.8-175.5-176c0-65.8 36-123.1 89.3-153.3c6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"></path>
        </svg>
        <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="sun" class="svg-inline--fa fa-sun sun" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zm224 0a128 128 0 1 0 -256 0 128 128 0 1 0 256 0z"></path>
        </svg></span>
    </label>
  </nav>
</header>
<script>
  window.onload = function() {
    let e = document.getElementById("switch-theme-checkbox")
    e.checked = document.documentElement.classList.contains("dark");
    e.checked ? e.parentElement.classList.add("active") : e.parentElement.classList.remove("active")
  }
  !function() {
    let e = document.getElementById("switch-theme-checkbox")
    e.checked = document.documentElement.classList.contains("dark")
    e.addEventListener("change", function() {
      if (document.documentElement.classList.contains("light")) {
        document.documentElement.classList.remove("light")
        document.documentElement.classList.add("dark")
      } else if (document.documentElement.classList.contains("dark")) {
        document.documentElement.classList.remove("dark")
        document.documentElement.classList.add("light")
      } else {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          document.documentElement.classList.add("dark")
        } else {
          document.documentElement.classList.add("light")
        }
      }
      document.documentElement.setAttribute("data-theme", this.checked ? "dark" : "light"),
        function(e) {
          window.localStorage && window.localStorage.setItem("theme", e)
        }(this.checked ? "dark" : "light"), this.checked ? this.parentElement.classList.add("active") : this.parentElement.classList.remove("active")
    }.bind(e))
  }();
</script>
<div class="body">
<div class="nav-container" data-component="spec" data-version="latest" id="split-0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../../index.html">Vulkan Specification</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../fundamentals.html">Fundamentals</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../initialization.html">Initialization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../devsandqueues.html">Devices and Queues</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../cmdbuffers.html">Command Buffers</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../synchronization.html">Synchronization and Cache Control</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../renderpass.html">Render Pass</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../shaders.html">Shaders</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../pipelines.html">Pipelines</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../memory.html">Memory Allocation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../resources.html">Resource Creation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../samplers.html">Samplers</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../descriptorsets.html">Resource Descriptors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../interfaces.html">Shader Interfaces</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../textures.html">Image Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../fragmentdensitymapops.html">Fragment Density Map Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../VK_ARM_tensors/tensorops.html">Tensor Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../queries.html">Queries</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../clears.html">Clear Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../copies.html">Copy Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../drawing.html">Drawing Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../fxvertex.html">Fixed-Function Vertex Processing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../tessellation.html">Tessellation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../geometry.html">Geometry Shading</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../VK_NV_mesh_shader/mesh.html">Mesh Shading</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../VK_HUAWEI_cluster_culling_shader/clusterculling.html">Cluster Culling Shading</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../vertexpostproc.html">Fixed-Function Vertex Post-Processing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../primsrast.html">Rasterization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../fragops.html">Fragment Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framebuffer.html">The Framebuffer</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../dispatch.html">Dispatching Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../device_generated_commands/generatedcommands.html">Device-Generated Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../sparsemem.html">Sparse Resources</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../VK_KHR_surface/wsi.html">Window System Integration (WSI)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../VK_KHR_deferred_host_operations/deferred_host_operations.html">Deferred Host Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../VK_EXT_private_data.html">Private Data</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../accelstructures.html">Acceleration Structures</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../VK_EXT_opacity_micromap/micromaps.html">Micromap</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../raytraversal.html">Ray Traversal</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../raytracing.html">Ray Tracing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../VK_NV_memory_decompression.html">Memory Decompression</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../videocoding.html">Video Coding</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../VK_NV_optical_flow/optical_flow.html">Optical Flow</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../executiongraphs.html">Execution Graphs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../VK_NV_external_compute_queue/VK_NV_external_compute_queue.html">External Compute Queues</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../VK_ARM_data_graph/graphs.html">Data graphs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../extensions.html">Extending Vulkan</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../features.html">Features</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../limits.html">Limits</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../formats.html">Formats</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../capabilities.html">Additional Capabilities</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../debugging.html">Debugging</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/spirvenv.html">Vulkan Environment for SPIR-V</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/memorymodel.html">Memory Model</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/compressedtex.html">Compressed Image Formats</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/versions.html">Core Revisions (Informative)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/extensions.html">Layers &amp; Extensions (Informative)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/roadmap.html">Vulkan Roadmap Milestones</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/deprecation.html">Deprecation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/boilerplate.html">API Boilerplate</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/invariance.html">Invariance</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/glossary.html">Lexicon</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/credits.html">Credits (Informative)</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Vulkan Specification</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <div class="title"><a href="../../../../tutorial/latest/00_Introduction.html">Khronos Vulkan Tutorial</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../tutorial/latest/00_Introduction.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../../glsl/latest/index.html">OpenGL Shading Language Specification</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../glsl/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../../refpages/latest/refpages/index.html">Vulkan API Reference Pages</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../refpages/latest/refpages/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../../features/latest/features/index.html">Vulkan Feature Descriptions</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../features/latest/features/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../../guide/latest/index.html">Vulkan Guide</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../guide/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../../samples/latest/README.html">Vulkan Samples</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../samples/latest/README.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <div class="title"><a href="../../index.html">Vulkan Specification</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article" id="split-1">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Vulkan Specification</a></li>
    <li><a href="dense_geometry_format.html">Compressed triangle data</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Compressed triangle data</h1>
<div class="sect1">
<h2 id="dense-geometry-format"><a class="anchor" href="#dense-geometry-format"></a>Dense Geometry Format Version 1 (DGF1)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The dense geometry format consists of an array of 128B blocks that encode
triangle data.
Each block holds a maximum of 64 triangles and 64 vertices.</p>
</div>
<div class="paragraph">
<p>It is expected that applications will construct DGF content by partitioning
meshes into small, spatially localized triangle sets, and attempting to pack
each set into a minimal number of DGF blocks.
An SAH-aware clustering strategy is crucial for good ray tracing
performance.
Pre-clustering the geometry in this manner greatly accelerates the
acceleration structure build since the implementation receives an efficient
spatial partitioning, and does not need to construct one from the original,
larger triangle set.</p>
</div>
<div class="paragraph">
<p>DGF compressors rely on the ability to reorder triangles within a mesh, and
rotate triangle vertices in a winding-preserving way.
The application must post-process any sideband data which depends on these
(shader-visible index buffers, per-triangle attributes).</p>
</div>
<div class="sect2">
<h3 id="_block_layout"><a class="anchor" href="#_block_layout"></a>Block Layout</h3>
<div class="paragraph">
<p>The 128B DGF block is organized into sections as shown below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../_images/DGF_block_layout.svg" alt="DGF block layout" width="800">
</div>
<div class="title">Figure 1. DGF block layout</div>
</div>
<div class="paragraph">
<p>The first 5 DWORDs of a DGF block consist of a fixed header, whose structure
is shown below.
All bit fields are ordered from LSB to MSB, bytes are 8 bits, and multi-byte
fields are little endian.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">struct DGFHeader
{
    // DWORD 0
    uint32_t magic                :  8; // must be 0x6
    uint32_t bits_per_index       :  2; // Encodes 3,4,5,6
    uint32_t num_vertices         :  6; // Number of vertices (1-64)
    uint32_t num_triangles        :  6; // Number of triangles (1-64)
    uint32_t geom_id_meta         : 10;

    // DWORD 1
    uint32_t exponent             :  8; // Float32 scale (exponent-only) with bias 127. Values 1-232 are supported.
    int32_t  x_anchor             : 24; // 24-bit signed two's complement (0x800000 represents -8,388,608)

    // DWORD 2
    uint32_t x_bits               :  4; // 1-16 (add 1 when decoding)
    uint32_t y_bits               :  4; // 1-16 (add 1 when decoding)
    int32_t  y_anchor             : 24; // 24-bit signed two's complement

    // DWORD 3
    uint32_t z_bits               :  4; // 1-16 (add 1 when decoding)
    uint32_t omm_descriptor_count :  3; // 0-7
    uint32_t geom_id_mode         :  1; // 0 = Constant Mode  1= Palette Mode
    int32_t  z_anchor             : 24; // 24-bit signed two's complement

    // DWORD 4
    uint32_t prim_id_base         : 29;
    uint32_t have_user_data       : 1; // if set, a UserData DWORD is present between the header and the front buffer
    uint32_t unused               : 2; // must be 0

    // 108B of variable-length data segments follow.
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>The per-vertex offsets are tightly packed in the DGF node immediately
following the header, in ascending order.
The size of each vertex must be 4b-aligned.
The size of the vertex data section is byte-aligned.
Pad bits are inserted as required, and all pad bits must be zero.
The optional OMM palette (if present) starts on the next byte boundary.
The optional GeomID palette (if present), starts on the next byte boundary
following the vertex data and OMM palette.</p>
</div>
<div class="paragraph">
<p>The region containing the vertex data, geomID palette, and OMM palette is
referred to as the "front buffer".
It is byte-aligned, and its total size may not exceed 96B.</p>
</div>
<div class="paragraph">
<p>The optional UserData DWORD, if present, is little-endian, and located
immediately after the header.
If UserData is present, the front buffer starts at byte 24.
If UserData is not present, the front buffer starts at byte 20.</p>
</div>
</div>
<div class="sect2">
<h3 id="_vertex_position_encoding"><a class="anchor" href="#_vertex_position_encoding"></a>Vertex Position Encoding</h3>
<div class="paragraph">
<p>DGF vertices are defined on a signed 24-bit quantization grid.
Each block stores the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a 24b-per-coordinate signed anchor position,</p>
</li>
<li>
<p>a variable-width (1-16b) unsigned offset for each vertex component
(relative to the anchor position),</p>
</li>
<li>
<p>a power-of-2 scale factor which is used to map from the quantization grid
to floating-point world coordinates (stored as an IEEE biased exponent).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An equivalent fixed-point encoding scheme is used by Epic&#8217;s "Nanite" system.</p>
</div>
<div class="paragraph">
<p>The decoded floating-point vertex position is computed as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">float3 dgf_decode(int24_t Anchor[3], uint16_t Offset[3], uint8_t Exponent)
{
    int x = Anchor[0] + Offset[0]; // 24b + 16b add.. 25b result
    int y = Anchor[1] + Offset[1];
    int z = Anchor[2] + Offset[2];

    float fx = (float)(x); // convert results to floating-point
    float fy = (float)(y);
    float fz = (float)(z);

    // apply a pow2 scale factor
    float scale = ldexp(1.0f, Exponent - 127);
    return float3(fx, fy, fz) * scale;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this encoding scheme the maximum representable value is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(0x7fffff + 0xffff) * 2^127 = 8,454,142 * 2^127 (roughly 1.438e+45)</pre>
</div>
</div>
<div class="paragraph">
<p>The minimum is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> (0x800000 * 2^127) = -8,388,608 * 2^127  (roughly -1.427e+45)</pre>
</div>
</div>
<div class="paragraph">
<p>This is a larger theoretical dynamic range than IEEE floating-point, and
there is no reason for implementations to support all of it.</p>
</div>
<div class="paragraph">
<p>The minimum and maximum IEEE floats which DGF can encode occur for exponent
232 and integer positions 0x800001 and 0x7fffff (Decimal values -8388607 and
8388607).
These values are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-340282326356119256160033759537265639424.000000 and +340282326356119256160033759537265639424.000000</pre>
</div>
</div>
<div class="paragraph">
<p>For context, the range of finite IEEE floats is slightly larger than these:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-340282346638528859811704183484516925440.000000 to +340282346638528859811704183484516925440.000000</pre>
</div>
</div>
<div class="paragraph">
<p>For these reasons, DGF only supports exponent values from 1 through 232.
This implies that denormals, NaNs, and infinities cannot be represented.
If a block encodes an exponent value outside the supported range, all
ray-triangle intersection tests against this block will have <strong>undefined</strong>
results.</p>
</div>
<div class="paragraph">
<p>For exponent values of 232, it is possible to encode a value which overflows
the IEEE single-precision range.
Results are <strong>undefined</strong> in this case.</p>
</div>
<div class="paragraph">
<p>An application can ensure crack-free results across blocks by selecting
matching quantization factors for any two neighboring blocks.
A simple way to ensure this is to pick a uniform quantization factor for an
entire mesh.</p>
</div>
</div>
<div class="sect2">
<h3 id="_handling_corner_cases"><a class="anchor" href="#_handling_corner_cases"></a>Handling Corner Cases</h3>
<div class="paragraph">
<p>The anchor+offset encoding scheme can be problematic for meshes containing
very large triangles.
A poor choice of quantization factor can cause the 16b per-vertex offsets or
the 24b per-block anchors to overflow.
This problem can be worked around in several ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Choosing a coarser quantization factor (trading off precision),</p>
</li>
<li>
<p>Subdividing large, problematic triangles (whether automatically or
manually),</p>
</li>
<li>
<p>Reverting to uncompressed geometry for problematic assets.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The use of a common quantization factor for X,Y, and Z can be problematic
for geometry which has a large extent on one coordinate axis but not the
others (for example, a freight train with individually modeled cars).
In this situation, a coarse quantization factor must be selected to enclose
the large coordinate range on the long axis, resulting in inadequate
precision on the other two axes.
The solution to this problem is to partition the object into multiple parts,
each authored in a local coordinate system, and positioned using instance
transforms.</p>
</div>
</div>
<div class="sect2">
<h3 id="_topology_encoding"><a class="anchor" href="#_topology_encoding"></a>Topology Encoding</h3>
<div class="sect3">
<h4 id="_topology_sections"><a class="anchor" href="#_topology_sections"></a>Topology Sections</h4>
<div class="paragraph">
<p>DGF represents mesh topology using a form of generalized triangle strip.
The order of the stored vertices is used to minimize the size of the
topology encoding.
The topology encoding consists of an array of triangle control values, and a
compressed index buffer.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Two control bits per triangle indicating its position relative to the
previous two triangles</p>
<div class="ulist">
<ul>
<li>
<p>The first triangle always uses RESTART, so this is not stored.</p>
</li>
<li>
<p>Ordered back to front (earlier triangles occupy higher bit positions).</p>
</li>
</ul>
</div>
</li>
<li>
<p>A compressed index buffer whose length is determined by the contents of
the control bits.</p>
<div class="ulist">
<ul>
<li>
<p>The index buffer is organized into two sections:</p>
<div class="ulist">
<ul>
<li>
<p>An array of "is-first" bits</p>
<div class="ulist">
<ul>
<li>
<p>One bit per index indicating whether it is the first reference to a
given vertex.</p>
</li>
<li>
<p>The first reference to a given vertex is computed by incrementing a
counter.</p>
</li>
<li>
<p>The first three indices are always "first", so their "is-first" bits
are not stored.</p>
</li>
<li>
<p>Ordered back to front (earlier indices occupy higher bit positions).</p>
</li>
</ul>
</div>
</li>
<li>
<p>A "reuse buffer" containing the indices of reused vertices</p>
<div class="ulist">
<ul>
<li>
<p>There is one index for each zero bit in the "is-first" bit vector.</p>
</li>
<li>
<p>The number of bits per index is stored in the header.
Valid values are 0,1,2,3, encoding 3,4,5, and 6 bits, respectively.</p>
</li>
<li>
<p>Ordered front to back (earlier indices occupy lower bit positions).</p>
</li>
<li>
<p>Total size may not exceed 24B.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The reuse buffer is located immediately adjacent to the front buffer.
The triangle control bits are located at the end of the block, and the
"is-first" bits are immediately in front of them.</p>
</div>
<div class="paragraph">
<p>There are four possible triangle control values:</p>
</div>
<table id="DGF-triangle_control_values" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Enum</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RESTART</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start a new strip, specifying 3 vertex indices for the triangle</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EDGE1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The second edge of the predecessor triangle is reused as the first edge</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EDGE2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The third edge of the predecessor triangle is reused as the first edge</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKTRACK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The opposite edge of the predecessor&#8217;s predecessor is reused.  "Opposite edge" means EDGE1 if the predecessor used EDGE2, or EDGE2 if the predecessor used EDGE1.  BACKTRACK is not allowed unless the predecessor used EDGE1 or EDGE2.  A BACKTRACK triangle may not occur after a RESTART or another BACKTRACK</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The behavior of the triangle control values is illustrated in the diagram
below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../_images/DGF_control_values.svg" alt="DGF control values">
</div>
<div class="title">Figure 2. DGF control value behavior</div>
</div>
<div class="paragraph">
<p>In the diagram above, the vertex orders for the 3 predecessor triangles are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RESTART: 0,1,2</p>
</li>
<li>
<p>EDGE1: 2,1,3 (reuse the 1&#8594;2 edge)</p>
</li>
<li>
<p>EDGE1: 3,1,4 (reuse the 1&#8594;3 edge)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The four possible vertex orders for the next triangle depend on its control
value, and are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RESTART: 5,6,7</p>
</li>
<li>
<p>EDGE1: 4,1,5 (reuse the 1&#8594;4 edge)</p>
</li>
<li>
<p>EDGE2: 3,4,5 (reuse the 4&#8594;3 edge)</p>
</li>
<li>
<p>BACKTRACK: 2,3,5 (reuse the 3&#8594;2 edge)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that whenever an edge is reused, its vertices are reversed so that
triangle winding is correct.
Meshes with mixed winding can be encoded by restarting the strip on each
winding change.</p>
</div>
<div class="paragraph">
<p>The control values for the triangles correspond to an index buffer
containing three indices for each RESTART triangle, and one index for each
non-RESTART triangle.
This index buffer is compressed by re-ordering the vertices by first use and
omitting the first reference to every vertex (since this index can be
computed by incrementing a counter).
A single bit per index is used to indicate whether it is the first reference
to its corresponding vertex.
The reused indices are then directly stored in a tightly-packed buffer
(i.e., not interleaved with the single-bit index-is-first flags).</p>
</div>
<div class="paragraph">
<p>The example below illustrates the index buffer encoding:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../_images/DGF_indices.svg" alt="DGF indices">
</div>
<div class="title">Figure 3. DGF Index buffer example</div>
</div>
<div class="paragraph">
<p>A triangle&#8217;s position in the index buffer can be computed by taking the
triangle index and adding 2 for each RESTART triangle at the same or earlier
positions.
This gives the index buffer position for the triangle&#8217;s third vertex.
The remaining two vertices are inferred from the previous two triangles
based on the control values.</p>
</div>
<div class="paragraph">
<p>An index from the compressed index buffer is extracted as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">uint get_index(uint indexPosition, uint64_t isFirst, uint nonFirstIndices[])
{
    // count number of "first" vertex refs which precede this one
    //   NOTE that an efficient implementation would use a popcount() here
    int numFirst = 0;
    for (int i = 0; i &lt; indexPosition; i++)
    {
        if (isFirst &amp; (1ull &lt;&lt; i))
            numFirst++;
    }

    // the first reference to each vertex is implicit
    // reused indices are read
    if (isFirst &amp; (1ull &lt;&lt; indexPosition))
        return numFirst;
    else
        return nonFirstIndices[indexPosition - numFirst];        // NOTE: Bounds check omitted for brevity

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_primitive_index"><a class="anchor" href="#_primitive_index"></a>Primitive Index</h3>
<div class="paragraph">
<p>The primitive index for a DGF triangle is inferred from its position in the
strip, which removes the need to directly store it.
A 29b primitive index base is stored in the block and added to the
triangle&#8217;s position in the block to produce a per-triangle primitive index.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">PrimitiveIndex = header.prim_id_base + triangle_index_in_block;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result must fit in 29b.
Any overflow results in <strong>undefined</strong> behavior.</p>
</div>
</div>
<div class="sect2">
<h3 id="_geometry_index_and_opaque_flag"><a class="anchor" href="#_geometry_index_and_opaque_flag"></a>Geometry Index and Opaque Flag</h3>
<div class="paragraph">
<p>DGF supports specifying a 24b geometry index and a 1b opaque flag on a
per-triangle basis.
These are combined into a 25b value with the opaque flag in the least
significant bit.</p>
</div>
<div class="paragraph">
<p>There are two supported modes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Constant mode: A 9b geometry index and 1b opaque flag is applied to all
triangles,</p>
</li>
<li>
<p>Palette mode: An array of up to 32 25b values is stored in the block, in
compressed form, and a per-triangle index is used to select a value from
the array.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If palette mode is in use, there is no requirement that the "opaque" flags
are consistent for triangles with the same geometry index.</p>
</div>
<div class="paragraph">
<p>The palette mode is useful in the following circumstances:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When the triangles in the block have different geometry index or opacity
values</p>
</li>
<li>
<p>When the triangles have the same geometry index, but it is larger than the
9b limit for palette mode.</p>
</li>
<li>
<p>When the number of triangles per geo is small, and constant mode would
create under-utilized blocks.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_geomid_palette"><a class="anchor" href="#_geomid_palette"></a>GeomID Palette</h4>
<div class="paragraph">
<p>There are two supported modes for specifying geometry indices and opaque
flags.
The mode is selected based on the <code>geom_id_mode</code> field in the header:</p>
</div>
<table id="DGF-mode-enum" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Enum</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Encoding System</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Constant Mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A 9b geomID and a 1b opaque flag are applied to all triangles</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Palette Mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An array of up to 32 25b values is stored in compressed form; each triangle stores an index into the array</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In constant mode, bit 0 of <code>geom_id_meta</code> contains an opaque flag, and bits
1-9 store a geometry index.
These values are used for all triangles.
In this mode, no additional data are stored in the block, and more space is
available for vertex data.</p>
</div>
<div class="paragraph">
<p>In palette mode, the <code>geom_id_meta</code> field is interpreted as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>LSBs (4:0) encode a GeomID prefix size in bits (5b, 0-25)</p>
</li>
<li>
<p>MSBs (9:5) encode a GeomID count (5b, 1-32 (add 1 when decoding)).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In palette mode, a GeomID palette structure is inserted in the block.
The position and size of the palette structure are aligned to byte
boundaries.
Pad bits are appended as required, and all pad bits must be zero.</p>
</div>
<div class="paragraph">
<p>The GeomID palette consists of the following structures in this order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A prefix value whose bit length is given in the 5 LSBs of <code>geom_id_meta</code>.</p>
</li>
<li>
<p>A per-triangle index buffer identifying the payload to use for each
triangle.</p>
<div class="ulist">
<ul>
<li>
<p>The size of each index is <code>ceil(log2(GeomID count))</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>An array of N-bit payloads, where N is <code>25 - prefixSize</code>.
The LSB of each payload contains an opaque flag.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The 25b geomID and opaque flag for a given triangle are decoded by selecting
a payload from the payload buffer, and concatenating it with the prefix
value.
The following pseudocode illustrates this process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">// Helper function to extract a bit field from the DGF block
uint ReadBits(uint bitPos, uint numBits);

uint get_id_and_opacity(uint geom_id_meta, uint triIndex, uint triCount);
{
    uint prefixSize  = geom_id_meta &amp; 0x1f;
    uint payloadSize = 25 - prefixSize;
    uint geomIDCount = ((geom_id_meta &gt;&gt; 5) &amp; 0x1f) + 1;
    uint indexSize   = 32 - lzcount(geomIDCount - 1);

    uint paletteBitPos = ComputePaletteBitPosition();
    uint prefix        = ReadBits(paletteBitPos, prefixSize);

    uint indexBufferPos = paletteBitPos + prefixSize;
    uint index          = ReadBits(indexBufferPos + triIndex * indexSize, indexSize);

    uint payloadBufferPos = indexBufferPos + triCount * indexSize;
    uint payload          = ReadBits(payloadBufferPos, index, payloadSize);

    return (prefix &lt;&lt; payloadSize) | payload;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_omm_support"><a class="anchor" href="#_omm_support"></a>OMM Support</h3>
<div class="paragraph">
<p>DGF provides a degree of OMM support by allowing the triangles within a DGF
block to collectively reference a limited number of OMMs.
The OMM support in DGF is best suited for scenarios in which a small set of
OMMs is repeated many times over a large mesh (e.g. tree leaves).
For intricate alpha cutouts applied to high-poly models, it is potentially
more efficient to tessellate the geometry and "bake in" the alpha cutout.</p>
</div>
<div class="paragraph">
<p>Because OMMs are constructed independently of acceleration structure
content, the encoder must reserve space for a set of implementation-defined
"OMM descriptors" which may be injected into the block at runtime.
A DGF block can hold a maximum of 7 descriptors, with each descriptor either
encoding an OMM special index or referencing an OMM array entry.
The application must know the triangle-to-OMM mapping when the DGF block is
encoded, and the encoder must assign triangles to blocks such that the
descriptor limit is not exceeded, and ideally such that the number of OMMs
per block is minimized.</p>
</div>
<div class="paragraph">
<p>The mapping of triangles to OMMs is illustrated by the following
pseudo-code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">//
//   The number of unique return values from "get_omm_index" in a given block must not
//     exceed the number of descriptors allocated in the block
//
uint get_omm_index( uint primIDBase, uint triangleIndexInBlock )
{
    // reconstruct primitive index
    uint primIndex = primIDBase + triangleIndexInBlock;

    // map primitive index to the index of an OMM in the OMM array
    if( indexed_omms )
        return OMMIndexBuffer[primIndex];
    else
        return primIndex;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If an OMM index buffer is used to select OMMs, then each distinct index
value (including "special indices") counts as one descriptor.
If there is no OMM index buffer, then a simple linear mapping is used
instead.
This implies that the number of OMM descriptors equals the number of
triangles, and that neither number may exceed 7.</p>
</div>
<div class="paragraph">
<p>DGF blocks with OMM still encode a per-triangle opaque flag.
This opaque flag is used whenever OMMs are disabled via ray/instance flags.</p>
</div>
<div class="sect3">
<h4 id="_opacity_micromap_palette"><a class="anchor" href="#_opacity_micromap_palette"></a>Opacity Micromap Palette</h4>
<div class="paragraph">
<p>If <code>omm_descriptor_count</code> is non-zero, then an "OMM palette" is present.
The OMM palette, if present, is byte-aligned.
Pad bits are inserted as required.
All pad bits must be zero.</p>
</div>
<div class="paragraph">
<p>The OMM palette consists of a "hot-patched" section, and a "pre-computed"
section.
The "hot-patched" section is so named because it is expected to be patched
at runtime with OMM information when an acceleration structure is
constructed.
The "pre-computed" section is computed by the application at DGF encoding
time.
The size and position of the hot-patched section are exposed to applications
through the API, but its precise contents are not.</p>
</div>
<div class="paragraph">
<p>When encoding a DGF block that is expected to be used with OMMs, the encoder
must reserve space for the hot-patched section, and place the pre-computed
section immediately after it.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The "hot-patched" section contains 8 bytes, plus 4 bytes for each OMM
descriptor.
The application must initialize this space with zeros.</p>
</li>
<li>
<p>The "pre-computed" section contains a per-triangle index indicating which
OMM descriptor to use.</p>
<div class="ulist">
<ul>
<li>
<p>Triangles are ordered from front to back in ascending order</p>
</li>
<li>
<p>The number of bits per index is derived from the <code>omm_descriptor_count</code>
field in the header.</p>
</li>
<li>
<p>The pre-computed section is padded out to the next byte boundary, and
all pad bits must be zero.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following table shows the OMM palette configuration for each value of
<code>omm_descriptor_count</code>:</p>
</div>
<table id="DGF-omm-palette-config" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">omm_descriptor_count</th>
<th class="tableblock halign-left valign-top">Hot-patch Section Size (Bytes)</th>
<th class="tableblock halign-left valign-top">Precomputed Section (Bits per Triangle)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">36</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following pseudo-code computes the size, in bits, of an OMM palette:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">int compute_palette_size( uint numDescriptors, uint numTriangles )
{
    if( numDescriptors == 0 )
	    return 0;

	uint hotPatchSize    = 64 + 32*numTriangles;
	uint bitsPerIndex    = ceil( log2(numDescriptors) );
	uint precomputedSize = bitsPerIndex*numTriangles;
    precomputedSize = (precomputedSize + 7) &amp; ~7; // byte align

	return hotPatchSize + precomputedSize;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following pseudo-code illustrates how an encoder could construct the
pre-computed section of the OMM palette:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">//
// Calculates the descriptor indices in the 'pre-computed' section of an OMM palette.
//   The return value is the number of OMM descriptors used.
//
// A return value of -1 indicates that the triangles contain too many unique OMMs and must be split into multiple blocks.
//
int build_omm_palette( uint descriptorIndices[], uint numTriangles, const int* ommIndices, uint spaceAvailable )
{
    int ommDescriptors[MAX_DESCRIPTORS];
    int numDescriptors=0;

    for( uint triangleIndex = 0; triangleIndex &lt; numTriangles; triangleIndex++ )
    {
	    // determine the OMM index assigned to this triangle
        int ommIndex = ommIndices[triangleIndex];

		// search for an existing descriptor for this OMM or special-index value
		uint descriptorIndex=0;

        while(descriptorIndex &lt; numDescriptors )
		{
			if( ommPalette[descriptorIndex] == ommIndex )
            	break;

            descriptorIndex++;
        }

		// if an existing descriptor was not found, attempt to allocate one
		//  if unsuccessful, the encoder must split the triangles into multiple blocks
		if( descriptorIndex == numDescriptors )
		{
			if( numDescriptors == MAX_DESCRIPTORS )
			    return -1; // block must be split
			else
			    ommPalette[numDescriptors++] = ommIndex;
            }

		descriptorIndices[triangleIndex] = descriptorIndex;
    }

	// split the triangles if the resulting palette cannot fit in the block
	if( compute_palette_size(numTriangles,numDescriptors) &gt; spaceAvailable )
	    return -1;

	return numDescriptors;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_optional_userdata"><a class="anchor" href="#_optional_userdata"></a>Optional UserData</h3>
<div class="paragraph">
<p>The DGF block can optionally embed one DWORD of user-defined data, which is
useful for locating vertex attributes.</p>
</div>
<div class="paragraph">
<p>Applications which use UserData must set the corresponding field in the DGF
header and populate the corresponding bits.</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/split.js"></script>
<script>
    // Splitter should only be visible in non-mobile layouts (where a hamburger menu is used for nav)
    var width = (window.innerWidth > 0) ? window.innerWidth : screen.width;
    var mobileNav = (width < 1024);

    if (!mobileNav) {
        var sizes = localStorage.getItem('split-sizes')

        if (sizes) {
            sizes = JSON.parse(sizes)
        } else {
            sizes = [25, 75]
        }

        var split = Split(['#split-0', '#split-1'], {
            sizes: sizes,
            onDragEnd: function (sizes) {
                localStorage.setItem('split-sizes', JSON.stringify(sizes))
            },
        })
    }
</script>
<script src="../../../../_/js/vendor/lunr.js" defer></script>
<script src="https://cdn.jsdelivr.net/pako/1.0.3/pako.min.js" defer></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css" defer></script>
<script>
window.addEventListener('DOMContentLoaded', function(){
  try {
    var script = document.getElementById('search-ui-script');
    var siteRoot = (script && script.getAttribute('data-site-root-path')) || '';
    var manifestUrl = siteRoot + '/search-index/manifest.json';
    fetch(manifestUrl)
      .then(function (r) { return r.ok ? r.json() : Promise.reject(new Error('manifest not found')) })
      .then(function (manifest) { antoraSearch.bootstrap(lunr, manifest, siteRoot); })
      .catch(function () {
        var s = document.createElement('script');
        s.async = true;
        s.src = siteRoot + '/search-index.js';
        document.head.appendChild(s);
      });
  } catch (e) {
    // Fallback to monolithic index if anything goes wrong
    var s = document.createElement('script');
    s.async = true;
    s.src = '../../../../search-index.js';
    document.head.appendChild(s);
  }
});
</script>
<script async src="../../../../_/js/vendor/tabs.js"></script>
  </body>
</html>
